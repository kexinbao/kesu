<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>投诉</title>
    <link rel="stylesheet" href="https://res.wx.qq.com/open/libs/weui/2.4.4/weui.min.css">
    <style>
        [v-cloak]{
            display:none;
        }
        .btnknow {
            font-size: 15px;
            color: #51628B;
            text-align: center;
            margin-top: 20px;
        }
        body{
            max-width: 600px;
            margin:auto;
            background-color: #f5f5f5;
            padding-bottom: 80px;
        }
        
        .x-title{
            padding-top: 16px;
            padding-bottom: 4px;
            padding-left: 16px;
            padding-right: 16px;
            color: rgba(0,0,0,.5);
            color: var(--weui-FG-1);
            font-size: 14px;
            line-height: 1.4;
            background-color:#ECECEC;
            margin-bottom: 0;
        }
        
        .x-title + .weui-cells {
            margin-top: 0;
        }
                
        .bottom-notice {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: #f5f5f5;
            padding: 15px 20px;
            text-align: center;
            font-size: 11px;
            color: #ddd;
            line-height: 1.4;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .notice-page {
            padding: 20px;
            background: white;
        }
        
        .notice-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }
        
        .notice-subtitle {
            font-size: 16px;
            font-weight: bold;
            margin-top: 20px;
            margin-bottom: 10px;
            color: #333;
        }
        
        .notice-content {
            font-size: 14px;
            line-height: 1.8;
            color: #666;
            margin-bottom: 10px;
        }
        
        .back-btn {
            margin-top: 30px;
        }
        
        .error-page {
            padding: 40px 20px;
            text-align: center;
        }
        
        .error-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }
        
        .error-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }
        
        .error-message {
            font-size: 14px;
            color: #999;
            margin-bottom: 30px;
        }
    </style>
</head>
<body data-weui-theme="light">
    <div id="app" v-cloak>
        <!-- 投诉须知页面 -->
        <div v-if="showNotice" class="notice-page">
            <h1 class="notice-title">投诉须知</h1>
            
            <div class="notice-content">
                你应保证你的投诉行为基于善意，并代表你本人真实意思。作为中立的平台服务者，收到你投诉后，会尽快按照相关法律法规的规定独立判断并进行处理。我们将会采取合理的措施保护你的个人信息；除法律法规规定的情形外，未经用户许可不会向第三方公开、透露你的个人信息。
            </div>
            
            <div class="notice-content">
                根据《中华人民共和国民法典》的规定，权利人在通知网络服务提供者时应当提供权利人的真实身份信息。因此，当你提交侵权投诉及冒充他人投诉时，我们根据你的主体类型，收集你的相关信息（含敏感个人信息），包括你的姓名或名称、证件号码或者组织证件号、证件正反面照片、公司或组织证件照片，收集前述内容的目的在于核验你的身份信息的真实性。如果你委托代理人进行投诉，我们还将收集代理人的姓名、证件号码、证件正反面照片、授权委托书照片，收集前述信息在于核验代理人信息的真实性。你可以拒绝提供，如果拒绝提供，我们可能无法对你的投诉进行评估，但不影响其他功能的正常使用。
            </div>
            
            <div class="weui-btn-area back-btn">
                <a href="javascript:void(0)" class="weui-btn weui-btn_primary" @click="showNotice = false">开始投诉</a>
            </div>
        </div>
        
        <!-- 错误页面 -->
        <div v-else-if="errorMsg" class="error-page">
            <div class="error-icon">⚠️</div>
            <h2 class="error-title">无法访问</h2>
            <p class="error-message">{{ errorMsg }}</p>
        </div>
        
        <!-- 正常投诉流程 -->
        <div v-else-if="!submitSuccess">
            <div v-if="hasChildTypes || currentTid === 0">
                <div class="x-title">
                    请选择投诉该账号的原因：
                </div>
                <div class="weui-cells">
                    <a href="javascript:void(0)" class="weui-cell weui-cell_access" v-for="item in list" :key="item.tid" @click="change(item)">
                        <div class="weui-cell__bd">
                            <p>{{item.text}}</p>
                        </div>
                        <div class="weui-cell__ft">
                        </div>
                    </a>
                </div>
                <div class="btnknow" @click="showNotice = true">投诉须知</div>
            </div>
            <div class="weui-form" v-else style="padding:0px">
                <div class="weui-form__control-area" style="margin:24px 0px">
                    <div class="weui-cells__group weui-cells__group_form">
                        <div class="weui-cells weui-cells_form">
                            <div class="weui-cell weui-cell_active">
                                <div class="weui-cell__hd">
                                    <label class="weui-label">
                                        手机号码 <span style="color:red">*</span>
                                    </label>
                                </div>
                                <div class="weui-cell__bd">
                                    <input placeholder="填写您的手机号码" class="weui-input" v-model="phone">
                                </div>
                                <div>
                                    <span v-if="!valid" style="color:rgb(244,127,143)">手机号码不正确</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="weui-cells__group weui-cells__group_form">
                        <div class="weui-cell weui-cell_uploader">
                            <div class="weui-cell__bd">
                                <div class="weui-uploader">
                                    <div class="weui-uploader__hd">
                                        <p class="weui-uploader__title">图片上传</p>
                                        <div class="weui-uploader__info">{{upload_files.length}}/9</div>
                                    </div>
                                    <div class="weui-uploader__bd">
                                        <ul class="weui-uploader__files" id="uploaderFiles">
                                            <li class="weui-uploader__file" :style="'background-image:url('+pic+')'" v-for="(pic, index) in upload_files" :key="index"></li>
                                        </ul>
                                        <div class="weui-uploader__input-box">
                                            <input id="uploaderInput" class="weui-uploader__input" type="file" accept="image/*" multiple @change="toUpload"/>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="weui-cells__group weui-cells__group_form">
                        <div class="weui-cells__title">
                            投诉内容 <span style="color:red">*</span>
                        </div>
                        <div class="weui-cells weui-cells_form">
                            <div class="weui-cell">
                                <div class="weui-cell__bd">
                                    <textarea placeholder="请描述你所发生的问题" rows="3" class="weui-textarea" v-model="content"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="weui-form__opr-area">
                    <a href="javascript:void(0)" class="weui-btn weui-btn_primary" @click="submit">
                        提交
                    </a>
                </div>
            </div>
        </div>
        
        <!-- 提交成功页面 -->
        <div class="page" v-else>
            <div class="weui-msg">
                <div class="weui-msg__icon-area"><i class="weui-icon-success weui-icon_msg"></i></div>
                <div class="weui-msg__text-area">
                    <h2 class="weui-msg__title">投诉已提交</h2>
                    <p class="weui-msg__desc">您的投诉内容已提交处理，我们会尽快核实，并通知您审核结果。感谢您的支持</p>
                </div>
                <div class="weui-msg__opr-area">
                    <p class="weui-btn-area">
                        <a href="javascript:void(0)" class="weui-btn weui-btn_primary" @click="closeWindow">关闭</a>
                    </p>
                </div>
            </div>
        </div>
                
        <!-- 底部说明文字 -->
        <div class="bottom-notice" v-if="!showNotice && !errorMsg">
            为保障您的合法权益与服务质量，本次投诉内容将提交给本企业管理员安排专属顾问联系您处理，请知悉!
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/vue@2.7.14/dist/vue.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
    <script>
        // ========================================
        // API 配置 - GitHub Pages 前后端分离
        // ========================================
        const apiBase = 'https://kesu.yituxs.com/api';
        
        // ========================================
        // 工具函数
        // ========================================
        
        // 从URL获取参数
        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            const redirect = params.get('redirect');
            
            if (redirect) {
                // 解析 /企业ID/通道编号
                const parts = redirect.split('/').filter(p => p);
                if (parts.length >= 2) {
                    return {
                        enterpriseId: parts[0],
                        channelSn: parts[1]
                    };
                }
            }
            return null;
        }
        
        // 验证手机号码
        function isValidMobileNumber(phoneNumber) {
            const regex = /^1[3-9]\d{9}$/;
            return regex.test(phoneNumber);
        }
        
        // 关闭窗口
        function closeWindow() {
            // 尝试多种关闭方式
            if (window.opener) {
                window.close();
            } else {
                window.location.href = 'about:blank';
                window.close();
            }
            
            // 如果是微信环境
            if (typeof WeixinJSBridge !== 'undefined') {
                WeixinJSBridge.call('closeWindow');
            }
        }
        
        // ========================================
        // Vue 应用
        // ========================================
        var app = new Vue({
            el: "#app",
            data: {
                apiBase: apiBase,
                currentTid: 0,
                submitSuccess: false,
                showNotice: false,
                upload_files: [],
                phone: "",
                content: "",
                type: "",
                sn: "",
                enterpriseId: "",
                time: "",
                valid: true,
                allList: [],
                errorMsg: "",
                channelInfo: null
            },
            mounted() {
                this.time = new Date().getTime();
                this.initPage();
            },
            computed: {
                list: function() {
                    return this.allList.filter((item) => {
                        return item.pid === this.currentTid
                    })
                },
                // 检查当前选中的投诉类型是否有子分类
                hasChildTypes: function() {
                    return this.allList.some((item) => {
                        return item.pid === this.currentTid
                    })
                }
            },
            methods: {
                // 初始化页面
                async initPage() {
                    const params = getUrlParams();
                    
                    if (!params) {
                        this.errorMsg = '缺少必需的参数，请从正确的链接访问';
                        return;
                    }
                    
                    this.enterpriseId = params.enterpriseId;
                    this.sn = params.channelSn;
                    
                    // 加载投诉类型和验证通道
                    await this.loadComplaintTypes();
                    await this.checkChannel();
                },
                
                // 加载投诉类型
                async loadComplaintTypes() {
                    try {
                        const response = await axios.get(`${apiBase}/get_complaint_types.php`, {
                            params: {
                                sn: this.sn
                            }
                        });
                        
                        if (response.data.code === 1) {
                            this.allList = response.data.data.types || [];
                            this.channelInfo = response.data.data.channel || null;
                            
                            // 如果没有投诉类型，使用默认类型
                            if (this.allList.length === 0) {
                                this.allList = [
                                    {tid: 1, pid: 0, text: '服务问题'},
                                    {tid: 2, pid: 0, text: '产品问题'},
                                    {tid: 3, pid: 0, text: '其他问题'}
                                ];
                            }
                        }
                    } catch (error) {
                        console.error('加载投诉类型失败:', error);
                        // 使用默认类型
                        this.allList = [
                            {tid: 1, pid: 0, text: '服务问题'},
                            {tid: 2, pid: 0, text: '产品问题'},
                            {tid: 3, pid: 0, text: '其他问题'}
                        ];
                    }
                },
                
                // 验证通道
                async checkChannel() {
                    try {
                        const formData = new FormData();
                        formData.append('type', 'check');
                        formData.append('sn', this.sn);
                        formData.append('time', this.time);
                        
                        const response = await axios.post(`${apiBase}/complain.php`, formData);
                        
                        if (response.data.code !== 1) {
                            this.errorMsg = response.data.msg || '通道验证失败';
                            
                            if (response.data.data && response.data.data.redirect) {
                                // 如果后端指定了跳转，可以选择跳转
                                // window.location.href = response.data.data.redirect;
                            }
                        }
                    } catch (error) {
                        console.error('通道验证失败:', error);
                        this.errorMsg = '网络错误，请稍后重试';
                    }
                },
                
                // 上传图片
                async toUpload(e) {
                    const files = e.target.files;
                    
                    for (let i = 0; i < files.length; i++) {
                        if (this.upload_files.length >= 9) {
                            alert('最多只能上传9张图片');
                            break;
                        }
                        
                        const file = files[i];
                        const formData = new FormData();
                        formData.append('img', file);
                        
                        try {
                            const response = await axios.post(`${apiBase}/upload_img.php`, formData, {
                                headers: {
                                    'Content-Type': 'multipart/form-data'
                                }
                            });
                            
                            if (response.data.code === 1 && response.data.data.url) {
                                // 将相对路径转换为完整URL
                                let imageUrl = response.data.data.url;
                                if (imageUrl.startsWith('/')) {
                                    imageUrl = apiBase.replace('/api', '') + imageUrl;
                                }
                                this.upload_files.push(imageUrl);
                            } else {
                                alert(response.data.msg || '图片上传失败');
                            }
                        } catch (error) {
                            console.error('图片上传失败:', error);
                            alert('图片上传失败，请重试');
                        }
                    }
                    
                    // 清空input，允许重复选择同一文件
                    e.target.value = '';
                },
                
                // 提交投诉
                async submit() {
                    // 验证
                    if (!this.phone) {
                        alert("请填写手机号码");
                        return;
                    }
                    
                    if (!isValidMobileNumber(this.phone)) {
                        this.valid = false;
                        alert("请填写有效的手机号码");
                        return;
                    }
                    
                    this.valid = true;
                    
                    if (!this.content) {
                        alert("请填写投诉内容");
                        return;
                    }
                    
                    // 提交数据
                    try {
                        const formData = new FormData();
                        formData.append('type', 'upload');
                        formData.append('phone', this.phone);
                        formData.append('content', this.content);
                        formData.append('pic', JSON.stringify(this.upload_files));
                        formData.append('complain', this.type);
                        formData.append('sn', this.sn);
                        formData.append('enterprise_id', this.enterpriseId);
                        
                        const response = await axios.post(`${apiBase}/upload.php`, formData);
                        
                        if (response.data.code === 1) {
                            this.submitSuccess = true;
                        } else {
                            alert(response.data.msg || '提交失败，请重试');
                        }
                    } catch (error) {
                        console.error('提交失败:', error);
                        alert('网络错误，请重试');
                    }
                },
                
                // 选择投诉类型
                change(item) {
                    // 检查这个投诉类型是否有子分类
                    const hasChildren = this.allList.some(child => child.pid === item.tid);
                    
                    if (hasChildren) {
                        // 如果有子分类，进入下一级选择
                        this.currentTid = item.tid;
                    } else {
                        // 如果没有子分类，直接设置类型并进入提交页面
                        this.currentTid = item.tid;
                        this.type = item.text;
                    }
                },
                
                // 关闭窗口
                closeWindow() {
                    closeWindow();
                }
            }
        });
    </script>
</body>
</html>
